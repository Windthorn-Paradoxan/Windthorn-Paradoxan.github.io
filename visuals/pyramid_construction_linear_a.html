<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyramid Construction - Linear A Engineering Specifications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1410;
            color: #e0d5c0;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background: linear-gradient(135deg, #2d2416 0%, #1a1410 100%);
            padding: 15px 20px;
            border-bottom: 3px solid #d4af37;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        
        h1 {
            color: #d4af37;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(212,175,55,0.5);
            margin-bottom: 3px;
            font-family: 'Georgia', serif;
        }
        
        .subtitle {
            color: #c19a6b;
            font-size: 12px;
            opacity: 0.9;
        }
        
        #main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        #canvas-area {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #4a3f2f 0%, #2d2416 50%, #1a1410 100%);
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        #linear-a-panel {
            width: 400px;
            background: rgba(45, 36, 22, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-left: 3px solid #8b7355;
            font-family: 'Courier New', monospace;
        }
        
        .spec-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(26, 20, 16, 0.8);
            border-left: 4px solid #d4af37;
            border-radius: 4px;
        }
        
        .spec-section.active {
            background: rgba(212, 175, 55, 0.15);
            border-left-color: #ffd700;
            box-shadow: 0 0 10px rgba(212,175,55,0.3);
        }
        
        .spec-title {
            color: #d4af37;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .linear-a-text {
            font-size: 20px;
            line-height: 1.8;
            color: #e0d5c0;
            letter-spacing: 2px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .translation {
            font-size: 11px;
            color: #c19a6b;
            line-height: 1.6;
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid #8b7355;
        }
        
        .phase-indicator {
            display: inline-block;
            padding: 3px 8px;
            background: #d4af37;
            color: #1a1410;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(45, 36, 22, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
            min-width: 300px;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        button {
            flex: 1;
            background: linear-gradient(135deg, #8b7355 0%, #6b5844 100%);
            color: #e0d5c0;
            border: 1px solid #d4af37;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: linear-gradient(135deg, #9b8365 0%, #7b6854 100%);
            border-color: #ffd700;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(212,175,55,0.3);
        }
        
        button.active {
            background: linear-gradient(135deg, #d4af37 0%, #b8942f 100%);
            color: #1a1410;
            font-weight: bold;
        }
        
        .slider-group {
            margin-bottom: 10px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #c19a6b;
            margin-bottom: 5px;
        }
        
        .slider-value {
            color: #d4af37;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #2d2416;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(212,175,55,0.5);
        }
        
        #progress-bar {
            width: 100%;
            height: 8px;
            background: #2d2416;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid #8b7355;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37 0%, #ffd700 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .info-box {
            background: rgba(26, 20, 16, 0.8);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 10px;
            line-height: 1.5;
            border-left: 3px solid #d4af37;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        
        .metric-label {
            color: #c19a6b;
        }
        
        .metric-value {
            color: #d4af37;
            font-weight: bold;
        }
        
        #legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(45, 36, 22, 0.95);
            padding: 12px 15px;
            border-radius: 6px;
            border: 2px solid #8b7355;
            font-size: 11px;
        }
        
        .legend-title {
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>‚ß´ Pyramid Construction ‚ß´ Linear A Engineering Protocol</h1>
            <div class="subtitle">Bronze Age Hydraulic Excavation Method ‚Ä¢ 96-Tick Solar Timing ‚Ä¢ EMx Framework</div>
        </div>
        
        <div id="main">
            <div id="canvas-area">
                <canvas id="pyramidCanvas"></canvas>
                
                <div id="legend">
                    <div class="legend-title">Construction Phases</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #d4af37;"></div>
                        <span>Excavation (Water)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #87ceeb;"></div>
                        <span>Hydraulic Flow</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #cd853f;"></div>
                        <span>Proto-Cement (3:1)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #daa520;"></div>
                        <span>Stone Layers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffd700;"></div>
                        <span>Solar Timing Rod</span>
                    </div>
                </div>
                
                <div id="controls">
                    <div class="control-row">
                        <button onclick="startConstruction()" id="btn-start">‚ñ∂ Start Build</button>
                        <button onclick="pauseConstruction()">‚è∏ Pause</button>
                        <button onclick="resetConstruction()">‚Üª Reset</button>
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Construction Speed</span>
                            <span class="slider-value" id="speed-val">1.0x</span>
                        </div>
                        <input type="range" id="speed-slider" min="0.1" max="5" step="0.1" value="1">
                    </div>
                    
                    <div id="progress-bar">
                        <div id="progress-fill"></div>
                    </div>
                    
                    <div class="info-box">
                        <div class="metric">
                            <span class="metric-label">Current Phase:</span>
                            <span class="metric-value" id="phase-name">Initialization</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Layer:</span>
                            <span class="metric-value" id="layer-num">0/10</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tick:</span>
                            <span class="metric-value" id="tick-num">0/96</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Depth:</span>
                            <span class="metric-value" id="depth-val">0.00m</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="linear-a-panel">
                <div class="spec-section active" id="spec-0">
                    <span class="phase-indicator">PHASE 0: INITIALIZATION</span>
                    <div class="spec-title">êòÄ Line 1: System Setup</div>
                    <div class="linear-a-text">
                        êòÄ êò∂(L)=4.2
                    </div>
                    <div class="translation">
                        <strong>êòÄ (A):</strong> Initialize at apex position (T‚ÇÄ singularity)<br>
                        <strong>êò∂(L)=4.2:</strong> Reference depth 4.2 meters<br>
                        <strong>Physical Action:</strong> Plant 4.2m sundial rod at center point<br>
                        <strong>EMx Operator:</strong> O‚ÇÅ (Lift) - establishes vertical reference
                    </div>
                </div>
                
                <div class="spec-section" id="spec-1">
                    <span class="phase-indicator">PHASE 1: HYDRAULIC ROUTING</span>
                    <div class="spec-title">êò¶ Line 2: Water Flow System</div>
                    <div class="linear-a-text">
                        êò¶‚ÜíêòÅ‚ü®êòß|êò©‚ü©
                    </div>
                    <div class="translation">
                        <strong>êò¶ (WA):</strong> Primary water channel from source<br>
                        <strong>‚Üí:</strong> Directional flow operator<br>
                        <strong>êòÅ (DA):</strong> Junction/decision point (sluice gate)<br>
                        <strong>‚ü®êòß|êò©‚ü©:</strong> Conditional branch (WI path OR ZA path)<br>
                        <strong>Engineering:</strong> Y-junction with gate control, operator chooses path based on sand stability<br>
                        <strong>EMx Operator:</strong> O‚ÇÇ (Flux) + O‚Çá (Exchange)
                    </div>
                </div>
                
                <div class="spec-section" id="spec-2">
                    <span class="phase-indicator">PHASE 2: TEMPORAL CYCLING</span>
                    <div class="spec-title">êòì Line 3: Solar-Timed Iterations</div>
                    <div class="linear-a-text">
                        êòì‚Üª96 êôï
                    </div>
                    <div class="translation">
                        <strong>êòì (QA):</strong> Cycle initiator<br>
                        <strong>‚Üª96:</strong> 96 iterations per day (15-minute intervals)<br>
                        <strong>êôï (NUM-10):</strong> 10 major layers<br>
                        <strong>Schedule:</strong> 96 water pulses daily √ó 10 layers = 960 total operations<br>
                        <strong>Timing:</strong> Shadow position on sundial triggers each pulse<br>
                        <strong>EMx Operator:</strong> O‚ÇÅ‚ÇÄ (Integration) + O‚ÇÑ (Closure)
                    </div>
                </div>
                
                <div class="spec-section" id="spec-3">
                    <span class="phase-indicator">PHASE 3: STABILIZATION</span>
                    <div class="spec-title">êò¥ Line 4: Proto-Cement Application</div>
                    <div class="linear-a-text">
                        êò¥+êò∂(3:1)‚Üíêòü
                    </div>
                    <div class="translation">
                        <strong>êò¥ (KU):</strong> Lime container (proto-cement base)<br>
                        <strong>+:</strong> Mixing operator<br>
                        <strong>êò∂(3:1):</strong> Ratio parameter (3 parts lime : 1 part gypsum/ash)<br>
                        <strong>‚Üí:</strong> Application direction<br>
                        <strong>êòü (SU):</strong> Symmetric application (mirror on all walls)<br>
                        <strong>Chemistry:</strong> CaCO‚ÇÉ ‚Üí CaO ‚Üí Ca(OH)‚ÇÇ ‚Üí CaCO‚ÇÉ (carbonation cycle)<br>
                        <strong>EMx Operator:</strong> O‚ÇÜ (Normalize) + O‚Çá (Symmetry)
                    </div>
                </div>
                
                <div class="spec-section" id="spec-4">
                    <span class="phase-indicator">PHASE 4: WATER MANAGEMENT</span>
                    <div class="spec-title">êò± Line 5: Three-Basin Cascade</div>
                    <div class="linear-a-text">
                        êò± êòÆ êò∏
                    </div>
                    <div class="translation">
                        <strong>êò± (HOL):</strong> Header tank (primary reservoir)<br>
                        <strong>êòÆ (DEA):</strong> Settling basin (intermediate storage)<br>
                        <strong>êò∏ (OIL):</strong> Output/distribution vessel<br>
                        <strong>Hydraulics:</strong> Gravity-fed cascade system<br>
                        <strong>Elevation:</strong> Each basin 1.4m drop (total 4.2m)<br>
                        <strong>‚àÖ‚ÇÄ Baseline:</strong> 22% reserve capacity in each basin<br>
                        <strong>EMx Operator:</strong> O‚ÇÜ (Containment) - three-stage normalization
                    </div>
                </div>
                
                <div class="spec-section" id="spec-5">
                    <span class="phase-indicator">PHASE 5: QUALITY CONTROL</span>
                    <div class="spec-title">êôÅ Line 6: Validation Protocol</div>
                    <div class="linear-a-text">
                        êôÅêôÅêôÅ ‚úì
                    </div>
                    <div class="translation">
                        <strong>êôÅêôÅêôÅ:</strong> Three FRAC-2 tallies = 6 validation points<br>
                        <strong>‚úì:</strong> Completion marker<br>
                        <strong>QA Protocol:</strong> Inspect after layers 2, 4, 6, 8, 10, and final<br>
                        <strong>Checks:</strong> Wall angle, cement adherence, water drainage, structural integrity<br>
                        <strong>EMx Operator:</strong> O‚Çà (Echo/Validation)
                    </div>
                </div>
                
                <div class="spec-section" id="spec-geometry">
                    <span class="phase-indicator">GEOMETRIC ENCODING</span>
                    <div class="spec-title">Pyramidal Mathematics</div>
                    <div class="linear-a-text">
                        êòÄ ‚Üí êò∂(Œ∏)‚âà51.84¬∞<br>
                        êò±(V) = (1/3)b¬≤h<br>
                        êò¶‚àáh = O‚ÇÇ(‚àá)
                    </div>
                    <div class="translation">
                        <strong>Slope Angle:</strong> Œ∏ ‚âà 51.84¬∞ (encodes 4/œÄ ratio)<br>
                        <strong>Volume Formula:</strong> V = (1/3) √ó base¬≤ √ó height<br>
                        <strong>Water Gradient:</strong> Flows down height gradient naturally<br>
                        <strong>Acoustic Resonance:</strong> Water-filled cavity ‚âà 178 Hz (F‚ôØ‚ÇÉ)<br>
                        <strong>Result:</strong> Inverted pyramid 4.2m deep with stabilized walls<br>
                        <strong>EMx Principle:</strong> O‚ÇÉ (Curvature) defines geometry
                    </div>
                </div>
                
                <div class="spec-section" id="spec-timing">
                    <span class="phase-indicator">SOLAR TIMING DETAIL</span>
                    <div class="spec-title">96-Tick Daily Schedule</div>
                    <div class="linear-a-text">
                        êòì‚Üª96: œÜ‚Çñ = 2œÄk/96
                    </div>
                    <div class="translation">
                        <strong>Dawn (œÜ=0¬∞):</strong> System activation, first pulse<br>
                        <strong>Every 15 min:</strong> Hydraulic pulse at shadow azimuth œÜ‚Çñ<br>
                        <strong>Noon (œÜ=180¬∞):</strong> Midpoint check, adjust flow rates<br>
                        <strong>Dusk (œÜ=360¬∞):</strong> Final pulse, cement application<br>
                        <strong>Night:</strong> Hydration/carbonation phase (O‚ÇÑ closure)<br>
                        <strong>Phase Calculation:</strong> œÜ‚Çñ = (2œÄ √ó k) / 96, where k = 0...95<br>
                        <strong>Rod Shadow:</strong> 4.2m gnomon casts precisely timed shadow
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('pyramidCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height, centerX, centerY;
        
        function resizeCanvas() {
            const container = document.getElementById('canvas-area');
            width = canvas.width = container.clientWidth;
            height = canvas.height = container.clientHeight;
            centerX = width / 2;
            centerY = height / 2;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Construction state
        let isBuilding = false;
        let isPaused = false;
        let buildSpeed = 1.0;
        let currentPhase = 0;
        let currentLayer = 0;
        let currentTick = 0;
        let progress = 0;
        let depth = 0;
        
        const TOTAL_LAYERS = 10;
        const TICKS_PER_LAYER = 96;
        const MAX_DEPTH = 4.2; // meters
        const BASE_SIZE = 200; // pixels
        
        // Water particles for hydraulic flow
        let waterParticles = [];
        
        class WaterParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = Math.random() * 3 + 2;
                this.life = 1.0;
                this.size = Math.random() * 3 + 1;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1; // gravity
                this.life -= 0.01;
            }
            
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = '#87ceeb';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }
        
        // Draw ground level
        function drawGround() {
            const groundY = centerY + 50;
            
            // Ground line
            ctx.strokeStyle = '#8b7355';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, groundY);
            ctx.lineTo(width, groundY);
            ctx.stroke();
            
            // Ground texture
            ctx.fillStyle = '#6b5844';
            ctx.fillRect(0, groundY, width, height - groundY);
        }
        
        // Draw sundial rod
        function drawSundialRod() {
            const groundY = centerY + 50;
            const rodHeight = 100; // 4.2m in pixels
            
            // Rod
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX, groundY);
            ctx.lineTo(centerX, groundY - rodHeight);
            ctx.stroke();
            
            // Rod top
            ctx.fillStyle = '#ffd700';
            ctx.beginPath();
            ctx.arc(centerX, groundY - rodHeight, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Shadow (rotates with tick)
            const shadowAngle = (currentTick / 96) * Math.PI * 2 - Math.PI / 2;
            const shadowLength = rodHeight * 0.8;
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(centerX, groundY);
            ctx.lineTo(
                centerX + Math.cos(shadowAngle) * shadowLength,
                groundY + Math.sin(shadowAngle) * shadowLength * 0.3
            );
            ctx.stroke();
        }
        
        // Draw inverted pyramid excavation
        function drawExcavation() {
            const groundY = centerY + 50;
            const currentDepth = (depth / MAX_DEPTH) * 150;
            const topWidth = BASE_SIZE;
            const bottomWidth = topWidth * (1 - depth / MAX_DEPTH * 0.6);
            
            // Excavation cavity
            ctx.fillStyle = '#3d2f1f';
            ctx.strokeStyle = '#8b7355';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(centerX - topWidth/2, groundY);
            ctx.lineTo(centerX - bottomWidth/2, groundY + currentDepth);
            ctx.lineTo(centerX + bottomWidth/2, groundY + currentDepth);
            ctx.lineTo(centerX + topWidth/2, groundY);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Water fill (if in hydraulic phase)
            if (currentPhase >= 1 && currentPhase <= 2) {
                const waterLevel = currentDepth * 0.7;
                const waterWidth = topWidth * (1 - (waterLevel / currentDepth) * 0.6);
                
                ctx.fillStyle = 'rgba(135, 206, 235, 0.5)';
                ctx.beginPath();
                ctx.moveTo(centerX - topWidth/2, groundY);
                ctx.lineTo(centerX - waterWidth/2, groundY + waterLevel);
                ctx.lineTo(centerX + waterWidth/2, groundY + waterLevel);
                ctx.lineTo(centerX + topWidth/2, groundY);
                ctx.closePath();
                ctx.fill();
                
                // Water surface shimmer
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const waveX = centerX - waterWidth/2 + (i / 4) * waterWidth;
                    const waveY = groundY + waterLevel + Math.sin(Date.now() * 0.003 + i) * 2;
                    if (i === 0) {
                        ctx.beginPath();
                        ctx.moveTo(waveX, waveY);
                    } else {
                        ctx.lineTo(waveX, waveY);
                    }
                }
                ctx.stroke();
            }
            
            // Cement layer (if in stabilization phase)
            if (currentPhase >= 3) {
                ctx.strokeStyle = '#cd853f';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(centerX - topWidth/2, groundY);
                ctx.lineTo(centerX - bottomWidth/2, groundY + currentDepth);
                ctx.lineTo(centerX + bottomWidth/2, groundY + currentDepth);
                ctx.lineTo(centerX + topWidth/2, groundY);
                ctx.closePath();
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // Draw three-basin cascade system
        function drawBasinSystem() {
            if (currentPhase < 4) return;
            
            const groundY = centerY + 50;
            const basinWidth = 40;
            const basinHeight = 30;
            
            // Basin positions (right side)
            const basins = [
                { x: centerX + 150, y: groundY - 120, label: 'êò± HOL' },
                { x: centerX + 150, y: groundY - 60, label: 'êòÆ DEA' },
                { x: centerX + 150, y: groundY, label: 'êò∏ OIL' }
            ];
            
            basins.forEach((basin, i) => {
                // Basin container
                ctx.fillStyle = '#6b5844';
                ctx.strokeStyle = '#d4af37';
                ctx.lineWidth = 2;
                ctx.fillRect(basin.x - basinWidth/2, basin.y, basinWidth, basinHeight);
                ctx.strokeRect(basin.x - basinWidth/2, basin.y, basinWidth, basinHeight);
                
                // Water inside (22% reserve - ‚àÖ‚ÇÄ baseline)
                const waterHeight = basinHeight * 0.78; // 78% full, 22% reserve
                ctx.fillStyle = 'rgba(135, 206, 235, 0.6)';
                ctx.fillRect(
                    basin.x - basinWidth/2 + 2,
                    basin.y + (basinHeight - waterHeight),
                    basinWidth - 4,
                    waterHeight
                );
                
                // Label
                ctx.fillStyle = '#d4af37';
                ctx.font = '10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(basin.label, basin.x, basin.y - 5);
                
                // Flow pipes between basins
                if (i < basins.length - 1) {
                    ctx.strokeStyle = '#87ceeb';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(basin.x, basin.y + basinHeight);
                    ctx.lineTo(basin.x, basins[i+1].y);
                    ctx.stroke();
                    
                    // Flow animation
                    const flowPhase = (Date.now() * 0.005) % 1;
                    const flowY = basin.y + basinHeight + flowPhase * (basins[i+1].y - basin.y - basinHeight);
                    ctx.fillStyle = '#87ceeb';
                    ctx.beginPath();
                    ctx.arc(basin.x, flowY, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Connection to excavation
            ctx.strokeStyle = '#87ceeb';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(basins[2].x, basins[2].y + basinHeight/2);
            ctx.lineTo(centerX + BASE_SIZE/2 - 20, groundY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // Draw stone layers (after excavation)
        function drawStoneLayers() {
            if (currentPhase < 5 || currentLayer === 0) return;
            
            const groundY = centerY + 50;
            const layerHeight = 15;
            
            for (let i = 0; i < currentLayer; i++) {
                const y = groundY + (i + 1) * layerHeight;
                const layerWidth = BASE_SIZE + i * 20;
                
                // Stone layer
                ctx.fillStyle = '#daa520';
                ctx.strokeStyle = '#8b7355';
                ctx.lineWidth = 1;
                ctx.fillRect(centerX - layerWidth/2, y, layerWidth, layerHeight);
                ctx.strokeRect(centerX - layerWidth/2, y, layerWidth, layerHeight);
                
                // Stone blocks
                for (let j = 0; j < 10; j++) {
                    const blockX = centerX - layerWidth/2 + (j / 10) * layerWidth;
                    ctx.strokeStyle = '#6b5844';
                    ctx.beginPath();
                    ctx.moveTo(blockX, y);
                    ctx.lineTo(blockX, y + layerHeight);
                    ctx.stroke();
                }
            }
        }
        
        // Update construction progress
        function updateConstruction() {
            if (!isBuilding || isPaused) return;
            
            // Advance tick
            currentTick += buildSpeed * 0.5;
            
            if (currentTick >= TICKS_PER_LAYER) {
                currentTick = 0;
                currentLayer++;
                
                if (currentLayer > TOTAL_LAYERS) {
                    currentLayer = TOTAL_LAYERS;
                    isBuilding = false;
                    currentPhase = 5;
                }
            }
            
            // Update depth
            depth = (currentLayer / TOTAL_LAYERS) * MAX_DEPTH;
            
            // Update phase based on layer
            if (currentLayer === 0) currentPhase = 0;
            else if (currentLayer <= 2) currentPhase = 1;
            else if (currentLayer <= 5) currentPhase = 2;
            else if (currentLayer <= 7) currentPhase = 3;
            else if (currentLayer <= 9) currentPhase = 4;
            else currentPhase = 5;
            
            // Update progress
            progress = ((currentLayer * TICKS_PER_LAYER + currentTick) / (TOTAL_LAYERS * TICKS_PER_LAYER)) * 100;
            
            // Add water particles during hydraulic phases
            if ((currentPhase === 1 || currentPhase === 2) && Math.random() < 0.3) {
                const sourceX = centerX + 150;
                const sourceY = centerY + 50 - 60;
                waterParticles.push(new WaterParticle(sourceX, sourceY));
            }
            
            // Update water particles
            waterParticles = waterParticles.filter(p => p.life > 0);
            waterParticles.forEach(p => p.update());
            
            // Update UI
            updateUI();
            updateActiveSpec();
        }
        
        // Update UI metrics
        function updateUI() {
            document.getElementById('phase-name').textContent = [
                'Initialization',
                'Hydraulic Routing',
                'Temporal Cycling',
                'Stabilization',
                'Water Management',
                'Quality Control'
            ][currentPhase];
            
            document.getElementById('layer-num').textContent = `${currentLayer}/${TOTAL_LAYERS}`;
            document.getElementById('tick-num').textContent = `${Math.floor(currentTick)}/${TICKS_PER_LAYER}`;
            document.getElementById('depth-val').textContent = depth.toFixed(2) + 'm';
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        // Update active specification section
        function updateActiveSpec() {
            for (let i = 0; i <= 5; i++) {
                const section = document.getElementById('spec-' + i);
                if (section) {
                    section.classList.toggle('active', i === currentPhase);
                }
            }
        }
        
        // Main render loop
        function render() {
            // Clear canvas
            ctx.fillStyle = '#2d2416';
            ctx.fillRect(0, 0, width, height);
            
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#4a3f2f');
            gradient.addColorStop(0.5, '#2d2416');
            gradient.addColorStop(1, '#1a1410');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Sun position based on tick
            if (currentTick > 0) {
                const sunAngle = (currentTick / TICKS_PER_LAYER) * Math.PI;
                const sunX = centerX + Math.cos(sunAngle - Math.PI/2) * 300;
                const sunY = 100 + Math.sin(sunAngle - Math.PI/2) * 80;
                
                const sunGradient = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 40);
                sunGradient.addColorStop(0, '#ffd700');
                sunGradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.5)');
                sunGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                ctx.fillStyle = sunGradient;
                ctx.fillRect(sunX - 40, sunY - 40, 80, 80);
            }
            
            // Draw construction elements
            drawGround();
            drawExcavation();
            drawSundialRod();
            drawBasinSystem();
            drawStoneLayers();
            
            // Draw water particles
            waterParticles.forEach(p => p.draw());
            
            // Update construction
            updateConstruction();
            
            requestAnimationFrame(render);
        }
        
        // Control functions
        function startConstruction() {
            isBuilding = true;
            isPaused = false;
            document.getElementById('btn-start').classList.add('active');
        }
        
        function pauseConstruction() {
            isPaused = !isPaused;
        }
        
        function resetConstruction() {
            isBuilding = false;
            isPaused = false;
            currentPhase = 0;
            currentLayer = 0;
            currentTick = 0;
            progress = 0;
            depth = 0;
            waterParticles = [];
            document.getElementById('btn-start').classList.remove('active');
            updateUI();
            updateActiveSpec();
        }
        
        // Speed slider
        document.getElementById('speed-slider').addEventListener('input', (e) => {
            buildSpeed = parseFloat(e.target.value);
            document.getElementById('speed-val').textContent = buildSpeed.toFixed(1) + 'x';
        });
        
        // Initialize
        updateUI();
        updateActiveSpec();
        render();
    </script>
</body>
</html>
